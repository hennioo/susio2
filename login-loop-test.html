<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login-Loop Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #333;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log {
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #4CAF50;
            max-height: 200px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #f44336;
        }
        .success {
            border-left-color: #2196F3;
        }
    </style>
</head>
<body>
    <h1>Login-Loop Test</h1>
    <p>Diese Seite simuliert die Login-Loop-Prüfung und den Schutz ohne den tatsächlichen Server.</p>

    <div class="test-section">
        <h2>1. Session Status</h2>
        <div>
            <button onclick="checkSessionStatus()">Session Status prüfen</button>
            <button onclick="resetSessionStorage()">Session Storage zurücksetzen</button>
            <button onclick="resetLocalStorage()">Local Storage zurücksetzen</button>
        </div>
        <div class="log" id="session-log"></div>
    </div>

    <div class="test-section">
        <h2>2. Login-Loop Simulation</h2>
        <div>
            <button onclick="simulateLoginLoop()">Login-Loop simulieren</button>
            <button onclick="simulateSuccessfulLogin()">Erfolgreichen Login simulieren</button>
        </div>
        <div class="log" id="loop-log"></div>
    </div>

    <div class="test-section">
        <h2>3. Aktueller Speicherstatus</h2>
        <button onclick="showStorageStatus()">Speicherstatus anzeigen</button>
        <div class="log" id="storage-log"></div>
    </div>

    <div class="test-section">
        <h2>4. Code-Prüfung</h2>
        <h3>Ursprünglicher Code (Login-Loop möglich)</h3>
        <pre>
// Bei Nicht-Authentifizierung, zur Login-Seite umleiten
statusMessage.textContent = 'Nicht authentifiziert. Leite zur Login-Seite weiter...';
setTimeout(() => {
    window.location.href = 'login.html';
}, 1500);
</pre>

        <h3>Neuer Code (mit Loop-Schutz)</h3>
        <pre>
// Nicht authentifiziert, aber wir setzen einen Loop-Schutz-Status
console.log('❌ Nicht authentifiziert. Bereite Weiterleitung zur Login-Seite vor...');
statusMessage.textContent = 'Nicht authentifiziert. Leite zur Login-Seite weiter...';

// Wir entfernen alle Session-Daten, um sauberen Zustand zu haben
localStorage.removeItem('session_initialized');

// Wir behalten die manuelle Session-ID, falls es nur ein temporäres Problem ist
// localStorage.removeItem('manual_session_id');

// Loop-Schutz aktivieren vor der Weiterleitung
setTimeout(() => {
    window.location.href = 'login.html?auto_redirect=1';
}, 1500);
</pre>
    </div>

    <script>
        const sessionLog = document.getElementById('session-log');
        const loopLog = document.getElementById('loop-log');
        const storageLog = document.getElementById('storage-log');

        // Hilfsfunktion zum Loggen
        function log(element, message, isError = false, isSuccess = false) {
            const entry = document.createElement('div');
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            if (isError) entry.classList.add('error');
            if (isSuccess) entry.classList.add('success');
            element.prepend(entry);
        }

        // Session Status prüfen
        function checkSessionStatus() {
            const sessionId = localStorage.getItem('manual_session_id');
            const isInitialized = localStorage.getItem('session_initialized');
            const redirectCount = sessionStorage.getItem('redirect_count');
            
            if (sessionId && isInitialized === 'true') {
                log(sessionLog, `Session aktiv! ID: ${sessionId.substring(0, 8)}...`, false, true);
            } else if (sessionId) {
                log(sessionLog, `Session-ID vorhanden (${sessionId.substring(0, 8)}...), aber nicht initialisiert`, true);
            } else {
                log(sessionLog, 'Keine aktive Session gefunden', true);
            }
            
            if (redirectCount) {
                log(sessionLog, `Redirect-Zähler: ${redirectCount}`, parseInt(redirectCount) > 2);
            }
        }

        // Session Storage zurücksetzen
        function resetSessionStorage() {
            sessionStorage.clear();
            log(sessionLog, 'Session Storage zurückgesetzt');
        }

        // Local Storage zurücksetzen
        function resetLocalStorage() {
            localStorage.removeItem('manual_session_id');
            localStorage.removeItem('session_initialized');
            log(sessionLog, 'Session aus Local Storage entfernt');
        }

        // Aktuellen Speicherstatus anzeigen
        function showStorageStatus() {
            storageLog.innerHTML = '';
            
            // Local Storage
            log(storageLog, '---- LOCAL STORAGE ----');
            let hasLocalData = false;
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                let value = localStorage.getItem(key);
                if (key === 'manual_session_id' && value.length > 10) {
                    value = value.substring(0, 8) + '...';
                }
                log(storageLog, `${key}: ${value}`);
                hasLocalData = true;
            }
            if (!hasLocalData) log(storageLog, 'Keine Daten im Local Storage');
            
            // Session Storage
            log(storageLog, '---- SESSION STORAGE ----');
            let hasSessionData = false;
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                log(storageLog, `${key}: ${sessionStorage.getItem(key)}`);
                hasSessionData = true;
            }
            if (!hasSessionData) log(storageLog, 'Keine Daten im Session Storage');
        }

        // Login-Loop simulieren
        function simulateLoginLoop() {
            let redirectCount = parseInt(sessionStorage.getItem('redirect_count') || '0');
            redirectCount++;
            sessionStorage.setItem('redirect_count', redirectCount);
            
            if (redirectCount > 3) {
                log(loopLog, `LOOP ERKENNT: ${redirectCount} Weiterleitungen - Abgebrochen`, true);
                return;
            }
            
            log(loopLog, `Login fehlgeschlagen, Weiterleitung #${redirectCount}`);
            
            // Neue Implementierung: Nur session_initialized löschen, nicht die ID
            localStorage.removeItem('session_initialized');
            // localStorage.removeItem('manual_session_id'); // alte Implementierung
            
            log(loopLog, 'Session als nicht-initialisiert markiert');
            log(loopLog, 'Weiterleitung zur login.html?auto_redirect=1 simuliert', false, true);
        }

        // Erfolgreichen Login simulieren
        function simulateSuccessfulLogin() {
            // Simulieren einer zufälligen Session-ID, falls keine existiert
            if (!localStorage.getItem('manual_session_id')) {
                const randomId = Math.random().toString(36).substring(2, 15);
                localStorage.setItem('manual_session_id', randomId);
                log(loopLog, `Neue Session-ID erstellt: ${randomId.substring(0, 8)}...`);
            }
            
            // Session als initialisiert markieren
            localStorage.setItem('session_initialized', 'true');
            
            // Redirect-Zähler zurücksetzen
            sessionStorage.removeItem('redirect_count');
            
            log(loopLog, 'Login erfolgreich! Session initialisiert', false, true);
            showStorageStatus();
        }

        // Anfänglichen Status anzeigen
        showStorageStatus();
    </script>
</body>
</html>