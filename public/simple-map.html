<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>susio - Karte (Vereinfacht)</title>
    <!-- Bootstrap Dark Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-dark-5@1.1.3/dist/css/bootstrap-dark.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
    <style>
        #map {
            height: 100vh;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: rgba(18, 18, 18, 0.9);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
        }
        .header-left, .header-right {
            display: flex;
            align-items: center;
        }
        .header-middle {
            flex-grow: 1;
            text-align: center;
        }
        .logo {
            color: #ff8c00;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }
        .logo:hover {
            color: #ff8c00;
        }
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        .header-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
            background-color: #2a2a2a;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header-icon:hover {
            background-color: #3a3a3a;
        }
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .spinner-big {
            width: 3rem;
            height: 3rem;
            margin-bottom: 1rem;
        }
        .debug-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: monospace;
            padding: 10px;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1001;
            display: none;
        }
    </style>
</head>
<body class="bg-dark text-white">
    <!-- Debug-Panel -->
    <div id="debug-panel" class="debug-panel"></div>
    
    <!-- Authentication Verification Overlay -->
    <div id="auth-overlay" class="auth-overlay">
        <div class="spinner-border text-warning spinner-big" role="status">
            <span class="visually-hidden">Lädt...</span>
        </div>
        <h4 class="text-white">Prüfe Anmeldestatus...</h4>
        <p class="text-muted" id="auth-status-message">Verbindung zum Server wird hergestellt...</p>
    </div>
    
    <!-- Simplified Map Container -->
    <div id="map"></div>
    
    <!-- App Header -->
    <header class="app-header">
        <div class="header-left">
            <img src="img/profile-placeholder.jpg" alt="Profil" class="profile-pic" id="profile-image">
        </div>
        
        <div class="header-middle">
            <a href="#" class="logo">susio</a>
        </div>
        
        <div class="header-right">
            <div class="header-icon" id="toggle-debug">
                <i class="fas fa-bug"></i>
            </div>
            <div class="header-icon" id="add-location-btn">
                <i class="fas fa-plus"></i>
            </div>
            <div class="header-icon" id="menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </header>
    
    <!-- JavaScript Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Debug-Funktionen
        const debugPanel = document.getElementById('debug-panel');
        let debugEnabled = false;
        
        // Debug-Modus umschalten
        document.getElementById('toggle-debug').addEventListener('click', () => {
            debugEnabled = !debugEnabled;
            debugPanel.style.display = debugEnabled ? 'block' : 'none';
        });
        
        // Log-Funktion
        function log(message, data = null) {
            const timestamp = new Date().toISOString();
            const logEntry = document.createElement('div');
            
            if (data) {
                logEntry.textContent = `[${timestamp}] ${message}`;
                console.log(`[${timestamp}] ${message}`, data);
                
                try {
                    const dataStr = typeof data === 'object' ? JSON.stringify(data, null, 2) : data.toString();
                    const dataElement = document.createElement('pre');
                    dataElement.textContent = dataStr;
                    dataElement.style.marginLeft = '20px';
                    dataElement.style.fontSize = '11px';
                    dataElement.style.color = '#aaffaa';
                    logEntry.appendChild(dataElement);
                } catch (e) {
                    // Ignorieren
                }
            } else {
                logEntry.textContent = `[${timestamp}] ${message}`;
                console.log(`[${timestamp}] ${message}`);
            }
            
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        // API-URL bestimmen
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? `http://${window.location.hostname}:3000`
            : '';
        
        // Session-ID aus verschiedenen Quellen holen
        function getStoredSessionId() {
            // Zuerst aus URL-Parametern prüfen
            const urlParams = new URLSearchParams(window.location.search);
            const urlSessionId = urlParams.get('sessionId');
            
            if (urlSessionId) {
                log('Session-ID aus URL-Parameter gefunden');
                // In den localStorage speichern für zukünftige Anfragen
                localStorage.setItem('manual_session_id', urlSessionId);
                return urlSessionId;
            }
            
            // Dann aus localStorage 
            const storedSessionId = localStorage.getItem('manual_session_id');
            return storedSessionId;
        }
        
        // Authentifizierung prüfen
        async function checkAuth() {
            const authOverlay = document.getElementById('auth-overlay');
            const statusMessage = document.getElementById('auth-status-message');
            const sessionId = getStoredSessionId();
            
            log('Prüfe Authentifizierung');
            log('Gespeicherte Session-ID', sessionId ? { id: sessionId.substring(0, 8) + '...' } : 'keine');
            
            try {
                // Headers für die Anfrage
                const headers = {
                    'Cache-Control': 'no-cache'
                };
                
                // Session-ID als Header hinzufügen, falls vorhanden
                if (sessionId) {
                    headers['X-Session-Id'] = sessionId;
                    log('Session-ID als Header hinzugefügt');
                }
                
                // Session-Status-Anfrage senden
                statusMessage.textContent = 'Authentifizierungsstatus wird überprüft...';
                
                log('Sende Session-Status-Anfrage an:', `${API_URL}/api/session-status`);
                const response = await fetch(`${API_URL}/api/session-status`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: headers
                });
                
                log('Server-Antwort Status:', response.status);
                
                // Response-Header protokollieren
                const responseHeaders = {};
                response.headers.forEach((value, name) => {
                    responseHeaders[name] = value;
                });
                log('Response-Header:', responseHeaders);
                
                // Response-Body lesen
                const responseText = await response.text();
                log('Response-Text:', responseText);
                
                const data = JSON.parse(responseText);
                
                if (response.ok && data.authenticated) {
                    // Erfolgreicher Auth-Check
                    log('✅ Authentifizierung erfolgreich!');
                    statusMessage.textContent = 'Authentifizierung erfolgreich! Karte wird geladen...';
                    
                    // Session-ID speichern/aktualisieren
                    if (data.sessionId) {
                        localStorage.setItem('manual_session_id', data.sessionId);
                        localStorage.setItem('session_initialized', 'true');
                        log('Session-ID aktualisiert');
                    }
                    
                    // Karte initialisieren
                    setTimeout(() => {
                        authOverlay.style.display = 'none';
                        initMap();
                    }, 1000);
                    
                    return true;
                } else {
                    // Nicht authentifiziert
                    log('❌ Nicht authentifiziert, Weiterleitung zur Login-Seite');
                    statusMessage.textContent = 'Nicht authentifiziert. Weiterleitung zur Login-Seite...';
                    
                    setTimeout(() => {
                        window.location.href = 'direct-test.html'; // Zur Test-Login-Seite weiterleiten
                    }, 1500);
                    
                    return false;
                }
            } catch (error) {
                // Fehler bei der Authentifizierung
                log('Fehler bei der Authentifizierungsprüfung:', error);
                statusMessage.textContent = 'Verbindungsfehler. Weiterleitung zur Login-Seite...';
                
                setTimeout(() => {
                    window.location.href = 'direct-test.html';
                }, 1500);
                
                return false;
            }
        }
        
        // Karte initialisieren
        function initMap() {
            log('Initialisiere Karte');
            
            // Karte erstellen und auf Berlin zentrieren
            const map = L.map('map').setView([52.5200, 13.4050], 12);
            
            // OpenStreetMap-Layer hinzufügen (Dark Theme)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);
            
            // Beispiel-Marker hinzufügen
            L.marker([52.5200, 13.4050])
                .addTo(map)
                .bindPopup('Berlin')
                .openPopup();
            
            log('Karte erfolgreich initialisiert');
        }
        
        // Beim Laden der Seite
        window.addEventListener('DOMContentLoaded', async () => {
            log('Seite geladen');
            await checkAuth();
        });
    </script>
</body>
</html>