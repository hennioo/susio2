<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>susio - Direkter Map-Zugriff</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #121212;
            color: #fff;
        }
        h1 {
            color: #ff8c00;
        }
        button {
            background-color: #ff8c00;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #e67e00;
        }
        #results {
            background-color: #1e1e1e;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        input {
            background-color: #2a2a2a;
            color: white;
            border: 1px solid #444;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>susio - Direkter Map-Zugriff</h1>
    
    <div class="card">
        <h2>Status</h2>
        <div id="status">Nicht authentifiziert</div>
        
        <h3>Gespeicherte Session</h3>
        <div id="stored-session">Keine Session gefunden</div>
    </div>
    
    <div class="card">
        <h2>Login</h2>
        <input type="password" id="access-code" placeholder="Zugangscode eingeben">
        <button id="login-btn">Anmelden</button>
    </div>
    
    <div class="card">
        <h2>Session-Aktionen</h2>
        <button id="check-session-btn">Session prüfen</button>
        <button id="goto-map-btn">Zur Karte</button>
        <button id="clear-session-btn">Session löschen</button>
    </div>
    
    <div id="results"></div>
    
    <script>
        // Basis-URL
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? `http://${window.location.hostname}:3000`
            : '';
        
        // DOM-Elemente
        const resultsEl = document.getElementById('results');
        const statusEl = document.getElementById('status');
        const storedSessionEl = document.getElementById('stored-session');
        const accessCodeInput = document.getElementById('access-code');
        
        // Ausgabe in die Konsole
        function log(message, data = null) {
            const now = new Date().toISOString();
            
            if (data) {
                console.log(`[${now}] ${message}`, data);
                
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${now}] ${message}`;
                
                const dataEntry = document.createElement('pre');
                dataEntry.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data.toString();
                dataEntry.style.color = '#aaffaa';
                dataEntry.style.paddingLeft = '20px';
                
                resultsEl.appendChild(logEntry);
                resultsEl.appendChild(dataEntry);
            } else {
                console.log(`[${now}] ${message}`);
                
                const logEntry = document.createElement('div');
                logEntry.textContent = `[${now}] ${message}`;
                resultsEl.appendChild(logEntry);
            }
            
            resultsEl.scrollTop = resultsEl.scrollHeight;
        }
        
        // Status aktualisieren
        function updateStatus() {
            const sessionId = localStorage.getItem('manual_session_id');
            const sessionInit = localStorage.getItem('session_initialized');
            
            if (sessionId) {
                storedSessionEl.textContent = `Session-ID: ${sessionId.substring(0, 8)}...`;
                statusEl.textContent = sessionInit === 'true' ? 'Authentifiziert' : 'Session vorhanden, aber nicht initialisiert';
            } else {
                storedSessionEl.textContent = 'Keine Session gefunden';
                statusEl.textContent = 'Nicht authentifiziert';
            }
        }
        
        // Session überprüfen
        async function checkSession() {
            log('Session wird überprüft...');
            
            try {
                const sessionId = localStorage.getItem('manual_session_id');
                
                // Headers zusammenstellen
                const headers = {
                    'Cache-Control': 'no-cache'
                };
                
                // Session-ID als Header hinzufügen, falls vorhanden
                if (sessionId) {
                    headers['X-Session-Id'] = sessionId;
                    log('Verwende Session-ID aus localStorage', { sessionId: sessionId.substring(0, 8) + '...' });
                } else {
                    log('Keine Session-ID im localStorage gefunden');
                }
                
                // Session-Status-Anfrage senden
                const response = await fetch(`${API_URL}/api/session-status`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: headers
                });
                
                log('Server-Antwort Status:', response.status);
                
                // Response-Header protokollieren
                const responseHeaders = {};
                response.headers.forEach((value, name) => {
                    responseHeaders[name] = value;
                });
                log('Response-Header:', responseHeaders);
                
                // Response-Body lesen
                const responseText = await response.text();
                log('Response-Text:', responseText);
                
                const data = JSON.parse(responseText);
                
                if (response.ok && data.authenticated) {
                    log('✅ Session ist gültig!');
                    
                    // Session-ID speichern/aktualisieren
                    if (data.sessionId) {
                        localStorage.setItem('manual_session_id', data.sessionId);
                        localStorage.setItem('session_initialized', 'true');
                        log('Session-ID aktualisiert');
                    }
                    
                    statusEl.textContent = 'Authentifiziert';
                    updateStatus();
                    return true;
                } else {
                    log('❌ Session ungültig oder abgelaufen');
                    statusEl.textContent = 'Nicht authentifiziert';
                    localStorage.removeItem('session_initialized');
                    return false;
                }
            } catch (error) {
                log('Fehler bei der Session-Überprüfung:', error);
                return false;
            }
        }
        
        // Login durchführen
        async function login(accessCode) {
            log('Login-Versuch wird gestartet...');
            
            try {
                // Login-Anfrage senden
                const response = await fetch(`${API_URL}/verify-access`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ accessCode })
                });
                
                log('Server-Antwort Status:', response.status);
                
                // Response-Header protokollieren
                const responseHeaders = {};
                response.headers.forEach((value, name) => {
                    responseHeaders[name] = value;
                });
                log('Response-Header:', responseHeaders);
                
                // Response-Body lesen
                const responseText = await response.text();
                log('Response-Text:', responseText);
                
                const data = JSON.parse(responseText);
                
                if (response.ok && !data.error) {
                    log('✅ Login erfolgreich!');
                    
                    // Session-ID speichern
                    if (data.sessionId) {
                        localStorage.setItem('manual_session_id', data.sessionId);
                        localStorage.setItem('session_initialized', 'true');
                        log('Session-ID gespeichert:', { sessionId: data.sessionId.substring(0, 8) + '...' });
                    } else {
                        log('⚠️ Keine Session-ID in der Antwort gefunden!');
                    }
                    
                    updateStatus();
                    return true;
                } else {
                    log('❌ Login fehlgeschlagen:', data.message);
                    return false;
                }
            } catch (error) {
                log('Fehler beim Login:', error);
                return false;
            }
        }
        
        // Event-Listener
        document.getElementById('login-btn').addEventListener('click', async () => {
            const accessCode = accessCodeInput.value.trim();
            
            if (!accessCode) {
                log('Bitte gib einen Zugangscode ein');
                return;
            }
            
            await login(accessCode);
        });
        
        document.getElementById('check-session-btn').addEventListener('click', async () => {
            await checkSession();
        });
        
        document.getElementById('goto-map-btn').addEventListener('click', async () => {
            const isValid = await checkSession();
            
            if (isValid) {
                log('Weiterleitung zur Karte...');
                window.location.href = 'map.html';
            } else {
                log('Bitte zuerst anmelden');
            }
        });
        
        document.getElementById('clear-session-btn').addEventListener('click', () => {
            localStorage.removeItem('manual_session_id');
            localStorage.removeItem('session_initialized');
            log('Session gelöscht');
            updateStatus();
        });
        
        // Beim Laden der Seite
        window.addEventListener('load', () => {
            log('Seite geladen, prüfe bestehende Session');
            updateStatus();
            checkSession();
        });
    </script>
</body>
</html>